---
title: "HRV analysis"
author: "Janice Tjeng"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Load packages
```{r}
library(RMySQL)
library(tidyverse)
library(lubridate)
library(robustbase)
library(stringr)
```

# Read data from E4, firstbeat, & MSband
```{r}
db <- dbConnect(MySQL(), user="deepresearcher", password="ctpc177!", dbname="deephealth2", host="deephealthlab.org")
e4 <- dbSendQuery(db,"SELECT * FROM viewl_e4_rr")
e4dat <- fetch(e4,n=-1) 
fb <- dbSendQuery(db, "SELECT * FROM viewl_firstbeat_rr")
fbdat <- fetch(fb, n=-1)
mb <- dbSendQuery(db, "SELECT * FROM viewl_msband_rr")
mbdat <- fetch(mb, n=-1)
```

# Read timing data
```{r}
timing <- read_csv("timing_data.csv")
df <- timing %>%
  select (Event, LWP2_0019, Activity) %>%
  rename("Time"="LWP2_0019")
n <- nrow(df)
dte <- mdy(as.character(df[1,"Time"]))
start <- as.character(df[2,"Time"])
end <- as.character(df[n,"Time"])
```

# Select rows for user 19 from E4 
```{r}
user19_l <- e4dat %>%
  filter(user=="lwp2_0019", device_location=="Left") %>% 
  mutate(readable_timestamp=as.POSIXct(readable_timestamp),
         e4_rr=e4_rr*1000) 
filter_time_day1_e4 <- user19_l %>%
  filter(strftime(readable_timestamp, "%H:%M:%S") >= start & strftime(readable_timestamp, "%H:%M:%S") <= end, date(readable_timestamp)==dte) 
```

# Select rows for user 19 from ECG
```{r}
user19_fb <- fbdat %>%
  filter(user=="lwp2_0019") %>% 
  mutate(readable_timestamp=as.POSIXct(readable_timestamp)) 
filter_time_day1_fb <- user19_fb %>%
  filter(strftime(readable_timestamp, "%H:%M:%S") >= start & strftime(readable_timestamp, "%H:%M:%S") <= end, date(readable_timestamp)==dte) 
```

# Select rows for user 19 from MSband 
```{r}
user19_l_mb <- mbdat %>%
  filter(user=="lwp2_0019", device_location=="Left") %>% 
  mutate(readable_timestamp=as.POSIXct(readable_timestamp),
         mb_rr=(mb_rr*1000)) 
filter_time_day1_mb <- user19_l_mb %>%
  filter(strftime(readable_timestamp, "%H:%M:%S") >= start & strftime(readable_timestamp, "%H:%M:%S") <= end, date(readable_timestamp)==dte) 
```

# Clean data

## Detect outlier, short RR-interval, based on z-score standardization. 

```{r}
# Standardize function, standard deviation based on median absolute deviation, a robust estimate of standard deviation
standardize <- function(rr){
  return ((rr-mean(rr))/sqrt(covMcd(rr)$cov[1])) # use more robust function
}

# Function to identify outlier
outlier_short <- function(rr){
  z <- standardize(rr)
  ind <- which(z<(-3)) # -3: limit in sd for outlier detection of short rr interval
  return (ind)
}

# Function to remove outlier, then add to subsequent beat
rm_short <- function(x,y){ # x is the index of outliers, y is the column of rr-interval
  for (i in 1:length(x)){
    if (x[i]<length(y)){
      y[x[i]+1] <- y[x[i]+1] + y[x[i]]
      y[x[i]] <- NA
    }
    else{  # if rr-interval is at the end of the array, just remove it without adding it to the next beat
      y[x[i]] <- NA
    }
  }
  return (y)
}

# Combine all functions
rm_short_comp <- function (rr){
  indx <- outlier_short(rr)
  clean <- rm_short(indx,rr)
  return (clean)
}
```

## Impute long rr-interval, applied after removing short
```{r}
impute_long <- function(rr){
  dmax <- (2*sqrt(covMcd(rr)$cov[1])) + mean(rr) # For imputation
  dp <- numeric()
  dp1 <- numeric()
  ind_long <- which(rr>dmax)
  for (i in 1:length(ind_long)){     # imputation if rr>dmax
    dp <- sum((rr[ind_long][i]-dmax), dp)
  }
  dp <- dp/length(ind_long)          # imputation if rr<=dmax
  rr[ind_long] <- rr[ind_long]-dp
  for (i in 1:length(rr[-ind_long])){
    dp1 <- sum((rr[-ind_long][i]-dmax), dp1)
  }
  dp1 <- dp1/length(rr[-ind_long])
  rr[-ind_long] <- rr[-ind_long]-dp1
  return (rr)
}
```


**E4**
```{r}
filter_time_day1_e4.clean <- filter_time_day1_e4 %>%
  mutate(e4_rr=rm_short_comp(e4_rr)) %>%
  filter(!is.na(e4_rr)) %>%
  mutate(e4_rr=impute_long(e4_rr))

# Plot
ggplot(filter_time_day1_e4.clean, aes(x=readable_timestamp, y=e4_rr)) + geom_line() +
  ggtitle("Plot of rr-interval against time, after removing outliers, \nmeasured by E4 on the left hand, \non first day of study, 2016-11- 15, for participant 19.") +
  ylab("RR interval in milliseconds") + 
  xlab("time")
```

**ECG**

```{r}
filter_time_day1_fb.clean <- filter_time_day1_fb %>%
  mutate(fb_rr=rm_short_comp(fb_rr)) %>%
  filter(!is.na(fb_rr)) %>%
  mutate(fb_rr=impute_long(fb_rr))

# Plot
ggplot(filter_time_day1_fb.clean, aes(x=readable_timestamp, y=fb_rr)) + geom_line() +
  ggtitle("Plot of rr-interval against time, after removing outliers, \nmeasured by ECG during the first day of study, \n2016-11- 15, for participant 19.") +
  ylab("RR interval in milliseconds") + 
  xlab("time")
```

**MSband**

```{r}
filter_time_day1_mb.clean <- filter_time_day1_mb %>%
  mutate(mb_rr=rm_short_comp(mb_rr)) %>%
  filter(!is.na(mb_rr)) %>%
  mutate(mb_rr=impute_long(mb_rr))

# Plot
ggplot(filter_time_day1_mb.clean, aes(x=readable_timestamp, y=mb_rr)) + geom_line() +
  ggtitle("Plot of rr-interval against time, after removing outliers, \nmeasured by MSband on the left hand, \non first day of study, 2016-11- 15, for participant 19.") +
  ylab("RR interval in milliseconds") + 
  xlab("time")
```

# RMSSD equation
```{r}
# x should be the column containing rr-interval, units in millisecond
HRV <- function(x){
  total <- 0
  for (i in 1:(length(x)-1)){
     total <- sum(total, (x[i+1] -x[i])^2, na.rm=T)
  }
  return (sqrt(total/(length(x)-1)))
}
```

# Select each period and calculate RMSSD for E4, fb, and MSband
```{r}
for (i in 3:(n-1)){
  # select rr-interval for E4
  rr_int_e4 <- filter_time_day1_e4.clean %>%
    filter(strftime(readable_timestamp, "%H:%M")>=df$Time[i] & strftime(readable_timestamp, "%H:%M") <df$Time[i+1])
  # select rr-interval for firstbeat
  rr_int_fb <- filter_time_day1_fb.clean %>%
  filter(strftime(readable_timestamp, "%H:%M")>=df$Time[i] & strftime(readable_timestamp, "%H:%M") < df$Time[i+1])
  # select rr-interval for MSband
  rr_int_mb <- filter_time_day1_mb.clean %>%
  filter(strftime(readable_timestamp, "%H:%M")>=df$Time[i] & strftime(readable_timestamp, "%H:%M") < df$Time[i+1])
  # calculate RMSSD for each e4 interval
  df$RMSSD_e4[i] <- HRV(rr_int_e4$e4_rr)
  # calculate RMSSD for each firstbeat interval
  df$RMSSD_fb[i] <- HRV(rr_int_fb$fb_rr)
  # calculate RMSSD for each firstbeat interval
  df$RMSSD_mb[i] <- HRV(rr_int_mb$mb_rr)
}
df$RMSSD_e4[n] <- NA
df$RMSSD_fb[n] <- NA
df$RMSSD_mb[n] <- NA

df #output
```

# Plot HRV over different periods for each device

```{r}
hrv_df <- df %>%
  slice(3:20) %>%
  gather(`RMSSD_e4`, `RMSSD_fb`, `RMSSD_mb`, key="Device", value="RMSSD") %>%
  mutate(Device=str_replace(Device, "^.*_", ""),
         Event=factor(Event, levels=df$Event[3:20]))

clr <- c("blue", "green", "purple", "red", "black", "purple", "blue", "green", "purple", "orange", "blue", "gray", "purple", "yellow", "pink", "black", "purple", "violet")
ggplot(hrv_df, aes(x=Event, y=RMSSD)) +
  geom_path(aes(group=Device)) +
  geom_point(aes(colour=Event)) +
  facet_wrap(~Device) +
  scale_colour_manual(values=clr, 
                      labels=paste(hrv_df$Event,hrv_df$Activity, sep=":"),
                      name=NULL) +
  #annotate(geom="text", x=1, y=50, label="E4") +
  #annotate(geom="text", x=1, y=30, label="ECG") +
  #annotate(geom="text", x=1, y=100, label="MSB") +
  ggtitle("Plot of RMSSD across events for each device") +
  ylab("RMSSD in milliseconds") +
  theme(legend.position="top", 
        legend.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1)) 
```

# Plot HRV across time window of 3min + 30s each, for E4. Working on function to increment by 30s. 
```{r}

```